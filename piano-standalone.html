<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MIDI Piano - Standalone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .connection-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            display: inline-block;
        }

        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        #statusText {
            font-weight: 600;
            color: #333;
        }

        .connection-form {
            display: flex;
            gap: 10px;
        }

        #serverUrl {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        #connectBtn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        #connectBtn:hover {
            background: #5568d3;
        }

        #connectBtn:active {
            transform: scale(0.98);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .octave-buttons {
            display: flex;
            gap: 10px;
        }

        .octave-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 18px;
            font-weight: bold;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .octave-buttons button:hover {
            background: #5568d3;
        }

        .octave-buttons button:active {
            transform: scale(0.95);
        }

        #velocity {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
        }

        #velocity::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        #velocity::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .sound-toggle {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sound-toggle.sound-off {
            background: #6c757d;
            color: white;
        }

        .sound-toggle.sound-on {
            background: #28a745;
            color: white;
        }

        .sound-toggle:hover {
            opacity: 0.9;
        }

        .sound-toggle:active {
            transform: scale(0.95);
        }

        .piano-container {
            overflow-x: auto;
            margin-bottom: 15px;
            background: #222;
            padding: 10px 5px;
            border-radius: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .piano-keyboard {
            display: inline-flex;
            position: relative;
            height: 200px;
        }

        .key {
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            cursor: pointer;
            transition: all 0.05s;
            flex-shrink: 0;
        }

        .key.white {
            width: 48px;
            height: 200px;
            background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
            border: 1px solid #222;
            border-radius: 0 0 5px 5px;
            z-index: 1;
            margin-right: -1px;
        }

        .key.black {
            position: absolute;
            width: 30px;
            height: 120px;
            background: linear-gradient(to bottom, #2c2c2c 0%, #1a1a1a 100%);
            border: 1px solid #000;
            border-radius: 0 0 3px 3px;
            z-index: 2;
        }

        .key.white:active,
        .key.white.active {
            background: linear-gradient(to bottom, #e0e0e0 0%, #d0d0d0 100%);
            transform: translateY(2px);
        }

        .key.black:active,
        .key.black.active {
            background: linear-gradient(to bottom, #1a1a1a 0%, #0a0a0a 100%);
            transform: translateY(2px);
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
        }

        .key.white .key-label {
            color: #666;
        }

        .key.black .key-label {
            color: #ccc;
        }

        .info {
            text-align: center;
            color: #666;
        }

        .info p {
            margin: 5px 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 8px 5px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 10px;
            }

            .controls {
                flex-direction: row;
                gap: 10px;
                padding: 10px;
            }

            .control-group {
                min-width: 150px;
            }

            .piano-container {
                padding: 8px 3px;
            }

            .key.white {
                width: 40px;
                height: 180px;
            }

            .key.black {
                width: 25px;
                height: 110px;
            }
        }

        @media (max-width: 480px) and (orientation: portrait) {
            .key.white {
                width: 32px;
                height: 160px;
            }

            .key.black {
                width: 20px;
                height: 100px;
            }

            .key-label {
                font-size: 8px;
            }
        }

        @media (orientation: landscape) {
            .container {
                padding: 8px 5px;
            }

            h1 {
                font-size: 18px;
                margin-bottom: 8px;
            }

            .connection-panel,
            .controls {
                padding: 8px;
                margin-bottom: 8px;
            }

            .piano-container {
                padding: 8px 3px;
                margin-bottom: 10px;
            }

            .piano-keyboard {
                height: 160px;
            }

            .key.white {
                width: 38px;
                height: 160px;
            }

            .key.black {
                width: 24px;
                height: 100px;
            }

            .info {
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>MIDI Piano</h1>

        <div class="connection-panel">
            <div class="connection-status">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Êú™Êé•Á∂ö</span>
            </div>
            <div class="connection-form">
                <input type="text" id="serverUrl" placeholder="ws://192.168.x.x:8080" value="ws://192.168.1.100:8080">
                <button id="connectBtn">Êé•Á∂ö</button>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>„Ç™„ÇØ„Çø„Éº„Éñ: <span id="octaveValue">4</span></label>
                <div class="octave-buttons">
                    <button id="octaveDown">-</button>
                    <button id="octaveUp">+</button>
                </div>
            </div>
            <div class="control-group">
                <label for="velocity">„Éô„É≠„Ç∑„ÉÜ„Ç£: <span id="velocityValue">80</span></label>
                <input type="range" id="velocity" min="1" max="127" value="80">
            </div>
            <div class="control-group sound-control">
                <label>„É≠„Éº„Ç´„É´Èü≥Â£∞</label>
                <button id="soundToggleBtn" class="sound-toggle sound-off">üîá Èü≥Â£∞„Ç™„Éï</button>
            </div>
        </div>

        <div class="piano-container">
            <div class="piano-keyboard" id="keyboard">
                <!-- „Éî„Ç¢„Éé„Ç≠„Éº„ÅØJavaScript„ÅßÁîüÊàê -->
            </div>
        </div>

        <div class="info">
            <p>„Çø„ÉÉ„Éó„Åó„Å¶ÊºîÂ•è„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà3„Ç™„ÇØ„Çø„Éº„ÉñË°®Á§∫Ôºâ</p>
            <p>Èü≥Âüü: C<span id="rangeStart">3</span> - B<span id="rangeEnd">5</span></p>
        </div>
    </div>

    <script>
        // MIDI Piano App - Client Side (Standalone)
        class MIDIPiano {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.octave = 4;
                this.velocity = 80;
                this.activeNotes = new Set();
                this.touchMap = new Map();
                this.soundEnabled = false; // „É≠„Éº„Ç´„É´Èü≥Â£∞„ÅÆ„Ç™„É≥/„Ç™„Éï
                this.audioContext = null;
                this.activeOscillators = new Map(); // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Ç™„Ç∑„É¨„Éº„Çø„Éº

                this.initElements();
                this.initAudio();
                this.createKeyboard();
                this.attachEventListeners();
                this.updateOctaveDisplay();
            }

            initAudio() {
                // AudioContext„ÅØ„É¶„Éº„Ç∂„Éº„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥Âæå„Å´ÂàùÊúüÂåñ
                this.audioContext = null;
            }

            ensureAudioContext() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }

            // MIDI„Éé„Éº„ÉàÁï™Âè∑„Åã„ÇâÂë®Ê≥¢Êï∞„ÇíË®àÁÆó
            midiToFrequency(midiNote) {
                return 440 * Math.pow(2, (midiNote - 69) / 12);
            }

            // „É≠„Éº„Ç´„É´Èü≥Â£∞„ÇíÂÜçÁîü
            playLocalSound(midiNote) {
                if (!this.soundEnabled) return;

                this.ensureAudioContext();

                // Êó¢Â≠ò„ÅÆ„Ç™„Ç∑„É¨„Éº„Çø„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂÖà„Å´ÂÅúÊ≠¢
                if (this.activeOscillators.has(midiNote)) {
                    this.stopLocalSound(midiNote);
                }

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.type = 'triangle'; // „Éî„Ç¢„Éé„Å£„ÅΩ„ÅÑÈü≥Ëâ≤
                oscillator.frequency.setValueAtTime(
                    this.midiToFrequency(midiNote),
                    this.audioContext.currentTime
                );

                // „Éô„É≠„Ç∑„ÉÜ„Ç£„Å´Âü∫„Å•„ÅèÈü≥Èáè
                const volume = (this.velocity / 127) * 0.3;
                gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(
                    volume * 0.8,
                    this.audioContext.currentTime + 0.1
                );

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                oscillator.start();

                this.activeOscillators.set(midiNote, { oscillator, gainNode });
            }

            // „É≠„Éº„Ç´„É´Èü≥Â£∞„ÇíÂÅúÊ≠¢
            stopLocalSound(midiNote) {
                const oscillatorData = this.activeOscillators.get(midiNote);
                if (oscillatorData) {
                    const { oscillator, gainNode } = oscillatorData;
                    gainNode.gain.linearRampToValueAtTime(
                        0.01,
                        this.audioContext.currentTime + 0.1
                    );
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                    this.activeOscillators.delete(midiNote);
                }
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                this.updateSoundButtonState();
                if (this.soundEnabled) {
                    this.ensureAudioContext();
                }
            }

            updateSoundButtonState() {
                if (this.soundToggleBtn) {
                    if (this.soundEnabled) {
                        this.soundToggleBtn.textContent = 'üîä Èü≥Â£∞„Ç™„É≥';
                        this.soundToggleBtn.classList.add('sound-on');
                        this.soundToggleBtn.classList.remove('sound-off');
                    } else {
                        this.soundToggleBtn.textContent = 'üîá Èü≥Â£∞„Ç™„Éï';
                        this.soundToggleBtn.classList.remove('sound-on');
                        this.soundToggleBtn.classList.add('sound-off');
                    }
                }
            }

            initElements() {
                this.serverUrlInput = document.getElementById('serverUrl');
                this.connectBtn = document.getElementById('connectBtn');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.statusText = document.getElementById('statusText');
                this.octaveValue = document.getElementById('octaveValue');
                this.velocitySlider = document.getElementById('velocity');
                this.velocityValue = document.getElementById('velocityValue');
                this.keyboard = document.getElementById('keyboard');
                this.soundToggleBtn = document.getElementById('soundToggleBtn');
                this.updateSoundButtonState();
            }

            createKeyboard() {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octaves = 3; // 3„Ç™„ÇØ„Çø„Éº„ÉñË°®Á§∫
                const whiteKeyWidth = 48;
                const blackKeyWidth = 30;

                this.keyboard.innerHTML = ''; // „ÇØ„É™„Ç¢
                let whiteKeyCount = 0;

                // ÈªíÈçµ„ÅÆ‰ΩçÁΩÆ„Ç™„Éï„Çª„ÉÉ„ÉàÔºàÂÆüÈöõ„ÅÆ„Éî„Ç¢„Éé„ÅÆÈÖçÁΩÆ„Å´Âêà„Çè„Åõ„ÇãÔºâ
                // C# D# - F# G# A#„ÅÆ„Éë„Çø„Éº„É≥
                const blackKeyOffsets = {
                    1: 0.7,  // C# (C„ÅÆÂè≥ÂØÑ„Çä)
                    3: 0.9,  // D# (D„ÅÆÂè≥ÂØÑ„Çä)
                    6: 0.65, // F# (F„ÅÆÂè≥ÂØÑ„Çä)
                    8: 0.75, // G# (G„ÅÆ‰∏≠Â§Æ„Çà„ÇäÂè≥)
                    10: 0.85 // A# (A„ÅÆÂè≥ÂØÑ„Çä)
                };

                for (let octave = 0; octave < octaves; octave++) {
                    for (let i = 0; i < 12; i++) {
                        const note = notes[i];
                        const isBlack = note.includes('#');
                        const key = document.createElement('div');
                        key.className = `key ${isBlack ? 'black' : 'white'}`;
                        key.dataset.note = i;
                        key.dataset.octave = octave;
                        key.dataset.noteName = note;

                        const label = document.createElement('span');
                        label.className = 'key-label';
                        label.textContent = octave === 1 ? note : ''; // Áúü„Çì‰∏≠„ÅÆ„Ç™„ÇØ„Çø„Éº„Éñ„ÅÆ„Åø„É©„Éô„É´Ë°®Á§∫
                        key.appendChild(label);

                        if (isBlack) {
                            // ÈªíÈçµ„ÅÆ‰ΩçÁΩÆ„ÇíÂÆüÈöõ„ÅÆ„Éî„Ç¢„Éé„Å´Ëøë„Å•„Åë„Çã
                            const ratio = blackKeyOffsets[i] || 0.5;
                            const offset = (whiteKeyCount - 1) * whiteKeyWidth + whiteKeyWidth * ratio - blackKeyWidth / 2;
                            key.style.left = `${offset}px`;
                        } else {
                            whiteKeyCount++;
                        }

                        this.keyboard.appendChild(key);
                    }
                }
            }

            attachEventListeners() {
                this.connectBtn.addEventListener('click', () => this.toggleConnection());

                // Èü≥Â£∞„Éà„Ç∞„É´„Éú„Çø„É≥
                if (this.soundToggleBtn) {
                    this.soundToggleBtn.addEventListener('click', () => this.toggleSound());
                }

                document.getElementById('octaveUp').addEventListener('click', () => {
                    if (this.octave < 8) {
                        this.octave++;
                        this.updateOctaveDisplay();
                    }
                });

                document.getElementById('octaveDown').addEventListener('click', () => {
                    if (this.octave > 0) {
                        this.octave--;
                        this.updateOctaveDisplay();
                    }
                });

                this.velocitySlider.addEventListener('input', (e) => {
                    this.velocity = parseInt(e.target.value);
                    this.velocityValue.textContent = this.velocity;
                });

                const keys = document.querySelectorAll('.key');
                keys.forEach(key => {
                    key.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const touches = e.changedTouches;
                        for (let touch of touches) {
                            const note = parseInt(key.dataset.note);
                            this.noteOn(note, touch.identifier, key);
                        }
                    }, { passive: false });

                    key.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        const touches = e.changedTouches;
                        for (let touch of touches) {
                            this.noteOffByTouch(touch.identifier, key);
                        }
                    }, { passive: false });

                    key.addEventListener('touchcancel', (e) => {
                        e.preventDefault();
                        const touches = e.changedTouches;
                        for (let touch of touches) {
                            this.noteOffByTouch(touch.identifier, key);
                        }
                    }, { passive: false });

                    key.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        const note = parseInt(key.dataset.note);
                        this.noteOn(note, 'mouse', key);
                    });

                    key.addEventListener('mouseup', (e) => {
                        e.preventDefault();
                        this.noteOffByTouch('mouse', key);
                    });

                    key.addEventListener('mouseleave', (e) => {
                        this.noteOffByTouch('mouse', key);
                    });
                });

                this.serverUrlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.toggleConnection();
                    }
                });
            }

            toggleConnection() {
                if (this.isConnected) {
                    this.disconnect();
                } else {
                    this.connect();
                }
            }

            connect() {
                const url = this.serverUrlInput.value.trim();
                if (!url) {
                    alert('„Çµ„Éº„Éê„ÉºURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                try {
                    this.ws = new WebSocket(url);

                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                        console.log('WebSocketÊé•Á∂öÂÆå‰∫Ü');
                    };

                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        console.log('WebSocketÊé•Á∂öÁµÇ‰∫Ü');
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket„Ç®„É©„Éº:', error);
                        alert('Êé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                    };

                    this.ws.onmessage = (event) => {
                        console.log('„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏:', event.data);
                    };

                } catch (error) {
                    console.error('Êé•Á∂ö„Ç®„É©„Éº:', error);
                    alert('Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }

            disconnect() {
                if (this.ws) {
                    this.activeNotes.forEach(midiNote => {
                        this.sendMIDI({ type: 'noteOff', note: midiNote, velocity: 0 });
                    });
                    this.activeNotes.clear();
                    this.touchMap.clear();

                    this.ws.close();
                    this.ws = null;
                }
                this.isConnected = false;
                this.updateConnectionStatus(false);
            }

            updateConnectionStatus(connected) {
                if (connected) {
                    this.statusIndicator.classList.add('connected');
                    this.statusText.textContent = 'Êé•Á∂ö‰∏≠';
                    this.connectBtn.textContent = 'ÂàáÊñ≠';
                    this.connectBtn.style.background = '#dc3545';
                } else {
                    this.statusIndicator.classList.remove('connected');
                    this.statusText.textContent = 'Êú™Êé•Á∂ö';
                    this.connectBtn.textContent = 'Êé•Á∂ö';
                    this.connectBtn.style.background = '#667eea';
                }
            }

            updateOctaveDisplay() {
                this.octaveValue.textContent = this.octave;
                const startOctave = this.octave - 1;
                const endOctave = this.octave + 1;
                document.getElementById('rangeStart').textContent = startOctave;
                document.getElementById('rangeEnd').textContent = endOctave;
            }

            noteOn(note, touchId, keyElement) {
                const keyOctave = parseInt(keyElement.dataset.octave);
                const baseOctave = this.octave - 1; // ‰∏≠Â§Æ„Çí„Éô„Éº„Çπ„Å´
                const midiNote = (baseOctave + keyOctave) * 12 + note + 12;

                if (this.touchMap.has(touchId)) {
                    return;
                }

                this.touchMap.set(touchId, midiNote);
                this.activeNotes.add(midiNote);
                keyElement.classList.add('active');

                // „É≠„Éº„Ç´„É´Èü≥Â£∞„ÇíÂÜçÁîü
                this.playLocalSound(midiNote);

                this.sendMIDI({
                    type: 'noteOn',
                    note: midiNote,
                    velocity: this.velocity
                });

                console.log(`Note ON: ${midiNote} (${keyElement.dataset.noteName}${baseOctave + keyOctave})`);
            }

            noteOffByTouch(touchId, keyElement) {
                const midiNote = this.touchMap.get(touchId);

                if (midiNote !== undefined) {
                    this.activeNotes.delete(midiNote);
                    this.touchMap.delete(touchId);
                    keyElement.classList.remove('active');

                    // „É≠„Éº„Ç´„É´Èü≥Â£∞„ÇíÂÅúÊ≠¢
                    this.stopLocalSound(midiNote);

                    this.sendMIDI({
                        type: 'noteOff',
                        note: midiNote,
                        velocity: 0
                    });

                    console.log(`Note OFF: ${midiNote}`);
                }
            }

            sendMIDI(data) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(data));
                } else {
                    console.warn('WebSocket„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new MIDIPiano();
        });
    </script>
</body>

</html>
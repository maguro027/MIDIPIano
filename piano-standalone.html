<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MIDI Piano - Standalone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .connection-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            display: inline-block;
        }

        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        #statusText {
            font-weight: 600;
            color: #333;
        }

        .connection-form {
            display: flex;
            gap: 10px;
        }

        #serverUrl {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        #connectBtn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        #connectBtn:hover {
            background: #5568d3;
        }

        #connectBtn:active {
            transform: scale(0.98);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .octave-buttons {
            display: flex;
            gap: 10px;
        }

        .octave-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 18px;
            font-weight: bold;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .octave-buttons button:hover {
            background: #5568d3;
        }

        .octave-buttons button:active {
            transform: scale(0.95);
        }

        #velocity {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
        }

        #velocity::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        #velocity::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .piano-container {
            overflow-x: auto;
            margin-bottom: 20px;
            background: #222;
            padding: 20px;
            border-radius: 10px;
        }

        .piano-keyboard {
            display: flex;
            position: relative;
            min-width: 100%;
            height: 200px;
        }

        .key {
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            cursor: pointer;
            transition: all 0.1s;
        }

        .key.white {
            width: 50px;
            height: 200px;
            background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
            border: 2px solid #222;
            border-radius: 0 0 5px 5px;
            z-index: 1;
        }

        .key.black {
            position: absolute;
            width: 30px;
            height: 120px;
            background: linear-gradient(to bottom, #2c2c2c 0%, #1a1a1a 100%);
            border: 2px solid #000;
            border-radius: 0 0 3px 3px;
            z-index: 2;
        }

        .key.white:active,
        .key.white.active {
            background: linear-gradient(to bottom, #e0e0e0 0%, #d0d0d0 100%);
            transform: translateY(2px);
        }

        .key.black:active,
        .key.black.active {
            background: linear-gradient(to bottom, #1a1a1a 0%, #0a0a0a 100%);
            transform: translateY(2px);
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
        }

        .key.white .key-label {
            color: #666;
        }

        .key.black .key-label {
            color: #ccc;
        }

        .info {
            text-align: center;
            color: #666;
        }

        .info p {
            margin: 5px 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
            }

            .controls {
                flex-direction: column;
            }

            .control-group {
                min-width: 100%;
            }

            .key.white {
                width: 40px;
                height: 180px;
            }

            .key.black {
                width: 24px;
                height: 110px;
            }
        }

        @media (max-width: 480px) {
            .key.white {
                width: 35px;
                height: 160px;
            }

            .key.black {
                width: 20px;
                height: 100px;
            }

            .key-label {
                font-size: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>MIDI Piano</h1>

        <div class="connection-panel">
            <div class="connection-status">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">未接続</span>
            </div>
            <div class="connection-form">
                <input type="text" id="serverUrl" placeholder="ws://192.168.x.x:8080" value="ws://192.168.1.100:8080">
                <button id="connectBtn">接続</button>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>オクターブ: <span id="octaveValue">4</span></label>
                <div class="octave-buttons">
                    <button id="octaveDown">-</button>
                    <button id="octaveUp">+</button>
                </div>
            </div>
            <div class="control-group">
                <label for="velocity">ベロシティ: <span id="velocityValue">80</span></label>
                <input type="range" id="velocity" min="1" max="127" value="80">
            </div>
        </div>

        <div class="piano-container">
            <div class="piano-keyboard" id="keyboard">
                <!-- ピアノキーはJavaScriptで生成 -->
            </div>
        </div>

        <div class="info">
            <p>タップして演奏してください</p>
            <p>オクターブ範囲: C<span id="rangeStart">4</span> - B<span id="rangeEnd">4</span></p>
        </div>
    </div>

    <script>
        // MIDI Piano App - Client Side (Standalone)
        class MIDIPiano {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.octave = 4;
                this.velocity = 80;
                this.activeNotes = new Set();
                this.touchMap = new Map();

                this.initElements();
                this.createKeyboard();
                this.attachEventListeners();
                this.updateOctaveDisplay();
            }

            initElements() {
                this.serverUrlInput = document.getElementById('serverUrl');
                this.connectBtn = document.getElementById('connectBtn');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.statusText = document.getElementById('statusText');
                this.octaveValue = document.getElementById('octaveValue');
                this.velocitySlider = document.getElementById('velocity');
                this.velocityValue = document.getElementById('velocityValue');
                this.keyboard = document.getElementById('keyboard');
            }

            createKeyboard() {
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const blackKeyPositions = [1, 3, 6, 8, 10];

                let whiteKeyIndex = 0;

                for (let i = 0; i < 12; i++) {
                    const note = notes[i];
                    const isBlack = note.includes('#');
                    const key = document.createElement('div');
                    key.className = `key ${isBlack ? 'black' : 'white'}`;
                    key.dataset.note = i;
                    key.dataset.noteName = note;

                    const label = document.createElement('span');
                    label.className = 'key-label';
                    label.textContent = note;
                    key.appendChild(label);

                    if (isBlack) {
                        const offset = whiteKeyIndex * 50 - 15;
                        key.style.left = `${offset}px`;
                    } else {
                        whiteKeyIndex++;
                    }

                    this.keyboard.appendChild(key);
                }
            }

            attachEventListeners() {
                this.connectBtn.addEventListener('click', () => this.toggleConnection());

                document.getElementById('octaveUp').addEventListener('click', () => {
                    if (this.octave < 8) {
                        this.octave++;
                        this.updateOctaveDisplay();
                    }
                });

                document.getElementById('octaveDown').addEventListener('click', () => {
                    if (this.octave > 0) {
                        this.octave--;
                        this.updateOctaveDisplay();
                    }
                });

                this.velocitySlider.addEventListener('input', (e) => {
                    this.velocity = parseInt(e.target.value);
                    this.velocityValue.textContent = this.velocity;
                });

                const keys = document.querySelectorAll('.key');
                keys.forEach(key => {
                    key.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const touches = e.changedTouches;
                        for (let touch of touches) {
                            const note = parseInt(key.dataset.note);
                            this.noteOn(note, touch.identifier, key);
                        }
                    }, { passive: false });

                    key.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        const touches = e.changedTouches;
                        for (let touch of touches) {
                            this.noteOffByTouch(touch.identifier, key);
                        }
                    }, { passive: false });

                    key.addEventListener('touchcancel', (e) => {
                        e.preventDefault();
                        const touches = e.changedTouches;
                        for (let touch of touches) {
                            this.noteOffByTouch(touch.identifier, key);
                        }
                    }, { passive: false });

                    key.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        const note = parseInt(key.dataset.note);
                        this.noteOn(note, 'mouse', key);
                    });

                    key.addEventListener('mouseup', (e) => {
                        e.preventDefault();
                        this.noteOffByTouch('mouse', key);
                    });

                    key.addEventListener('mouseleave', (e) => {
                        this.noteOffByTouch('mouse', key);
                    });
                });

                this.serverUrlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.toggleConnection();
                    }
                });
            }

            toggleConnection() {
                if (this.isConnected) {
                    this.disconnect();
                } else {
                    this.connect();
                }
            }

            connect() {
                const url = this.serverUrlInput.value.trim();
                if (!url) {
                    alert('サーバーURLを入力してください');
                    return;
                }

                try {
                    this.ws = new WebSocket(url);

                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                        console.log('WebSocket接続完了');
                    };

                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        console.log('WebSocket接続終了');
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocketエラー:', error);
                        alert('接続エラーが発生しました');
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                    };

                    this.ws.onmessage = (event) => {
                        console.log('サーバーからのメッセージ:', event.data);
                    };

                } catch (error) {
                    console.error('接続エラー:', error);
                    alert('接続に失敗しました');
                }
            }

            disconnect() {
                if (this.ws) {
                    this.activeNotes.forEach(midiNote => {
                        this.sendMIDI({ type: 'noteOff', note: midiNote, velocity: 0 });
                    });
                    this.activeNotes.clear();
                    this.touchMap.clear();

                    this.ws.close();
                    this.ws = null;
                }
                this.isConnected = false;
                this.updateConnectionStatus(false);
            }

            updateConnectionStatus(connected) {
                if (connected) {
                    this.statusIndicator.classList.add('connected');
                    this.statusText.textContent = '接続中';
                    this.connectBtn.textContent = '切断';
                    this.connectBtn.style.background = '#dc3545';
                } else {
                    this.statusIndicator.classList.remove('connected');
                    this.statusText.textContent = '未接続';
                    this.connectBtn.textContent = '接続';
                    this.connectBtn.style.background = '#667eea';
                }
            }

            updateOctaveDisplay() {
                this.octaveValue.textContent = this.octave;
                document.getElementById('rangeStart').textContent = this.octave;
                document.getElementById('rangeEnd').textContent = this.octave;
            }

            noteOn(note, touchId, keyElement) {
                const midiNote = this.octave * 12 + note + 12;

                if (this.touchMap.has(touchId)) {
                    return;
                }

                this.touchMap.set(touchId, midiNote);
                this.activeNotes.add(midiNote);
                keyElement.classList.add('active');

                this.sendMIDI({
                    type: 'noteOn',
                    note: midiNote,
                    velocity: this.velocity
                });

                console.log(`Note ON: ${midiNote} (${keyElement.dataset.noteName}${this.octave})`);
            }

            noteOffByTouch(touchId, keyElement) {
                const midiNote = this.touchMap.get(touchId);

                if (midiNote !== undefined) {
                    this.activeNotes.delete(midiNote);
                    this.touchMap.delete(touchId);
                    keyElement.classList.remove('active');

                    this.sendMIDI({
                        type: 'noteOff',
                        note: midiNote,
                        velocity: 0
                    });

                    console.log(`Note OFF: ${midiNote}`);
                }
            }

            sendMIDI(data) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(data));
                } else {
                    console.warn('WebSocketが接続されていません');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new MIDIPiano();
        });
    </script>
</body>

</html>